<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>  

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../oe-amount.html">
  </head>
  <body>

    <!-- You can use the document as a place to set up your fixtures. -->
    <test-fixture id="oe-amount-list">
      <template>
          <oe-amount label="Currency List" currency-display="symbol" currency-list="[{&quot;symbol&quot;:&quot;$&quot;,&quot;name&quot;:&quot;USD&quot;,&quot;precision&quot;:2},{&quot;symbol&quot;:&quot;INR&quot;,&quot;name&quot;:&quot;INR&quot;,&quot;precision&quot;:3},{&quot;symbol&quot;:&quot;YEN&quot;,&quot;name&quot;:&quot;YEN&quot;,&quot;precision&quot;:1}]"></oe-amount>
      </template>
    </test-fixture>

    <test-fixture id="oe-amount-url">
        <template>
            <oe-amount label="Currency URL" currency-display="symbol" currency-url="../currency.json"></oe-amount>
        </template>
      </test-fixture>

    <script>
      suite('<oe-amount> list', function() {

        var myEl;

        setup(function() {
          myEl = fixture('oe-amount-list');
        });

        test('Check default value of currency list is set', function() {
          assert.equal(myEl.currency.symbol, '$');
          assert.equal(myEl.currency.name, 'USD');
          assert.equal(myEl.currency.precision, 2);
        });

        test('Set value for amount and check precision', function() {
          myEl.set('amount', 1234.5678);
          assert.equal(myEl.value.amount, 1234.57);
          assert.equal(myEl.value.currency.symbol, '$');
          assert.equal(myEl.value.currency.name, 'USD');
          assert.equal(myEl.value.currency.precision, 2);
        });

        test('Change currency and check precision change', function() {
          myEl.set('currency', myEl.currencyList[1]);
          myEl.set('amount', 1234.5678);
          assert.equal(myEl.value.amount, 1234.568);
          myEl.set('currency', myEl.currencyList[2]);
          assert.equal(myEl.value.amount, 1234.6);
        });

        test('Check float label and underline when focused', function() {
          var eleDecimal = myEl.$.amtValue.querySelector(".underline");
          var eleCombo = myEl.$.ccyValue.querySelector(".underline");
          
          MockInteractions.focus(myEl.$.amtValue);
          assert.isTrue(eleDecimal.classList.contains("is-highlighted"));
          assert.isTrue(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.blur(myEl.$.amtValue);
          assert.isFalse(eleDecimal.classList.contains("is-highlighted"));
          assert.isFalse(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.focus(myEl.$.ccyValue);
          assert.isTrue(eleDecimal.classList.contains("is-highlighted"));
          assert.isTrue(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.focus(myEl.$.amtValue);
          assert.isTrue(eleDecimal.classList.contains("is-highlighted"));
          assert.isTrue(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.blur(myEl.$.amtValue);
          assert.isFalse(eleDecimal.classList.contains("is-highlighted"));
          assert.isFalse(eleCombo.classList.contains("is-highlighted"));
        });

        test('Check _validate method', function() {
          assert.isFalse(myEl._validate());
          myEl.set('amount', 1234.5678);
          assert.isTrue(myEl._validate());
        });

        test('Check numberFormat error for amount', function() {
          var input = myEl.$.amtValue;
          
          MockInteractions.focus(input.inputElement);
          input.inputElement.set('value', 'foobar');
          input.inputElement.fire('change');
          MockInteractions.blur(input.inputElement);
  
  
          forceXIfStamp(input);
          var error = Polymer.dom(input.root).querySelector('oe-input-error');
          var errorAmt = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(input.invalid, 'invalid is true');
          assert.equal(input.errorMessage, 'numberFormat');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'numberFormat');

          assert.ok(errorAmt, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'numberFormat');
          assert.isTrue(errorAmt.invalid, 'invalid is true');
          assert.equal(errorAmt.errorMessage, 'numberFormat');
        });

        test('Check custom error for amount', function() {
          myEl.setAttribute("user-error-message", "Custom user error message")
          var input = myEl.$.amtValue;
          
          MockInteractions.focus(input.inputElement);
          input.inputElement.set('value', 'foobar');
          input.inputElement.fire('change');
          MockInteractions.blur(input.inputElement);
  
  
          forceXIfStamp(input);
          var error = Polymer.dom(input.root).querySelector('oe-input-error');
          var errorAmt = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(input.invalid, 'invalid is true');
          assert.equal(input.errorMessage, 'Custom user error message');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'Custom user error message');

          assert.ok(errorAmt, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'Custom user error message');
          assert.isTrue(errorAmt.invalid, 'invalid is true');
          assert.equal(errorAmt.errorMessage, 'Custom user error message');
        });

        test('Check invalidValue error for currency', function() {
          MockInteractions.focus(myEl.$.ccyValue);
          myEl.$.ccyValue.set("value", "");
          MockInteractions.blur(myEl.$.ccyValue);
          var error = Polymer.dom(myEl.$.ccyValue.root).querySelector('oe-input-error');
          var errorCcy = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.$.ccyValue.invalid, 'invalid is true');
          assert.equal(myEl.$.ccyValue.errorMessage, 'invalidValue');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'invalidValue');

          assert.ok(errorCcy, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorCcy).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'invalidValue');
          assert.isTrue(errorCcy.invalid, 'invalid is true');
          assert.equal(errorCcy.errorMessage, 'invalidValue');
        });

        test('Check custom error for currency', function() {
          myEl.setAttribute("user-error-message", "Custom user error message")
          MockInteractions.focus(myEl.$.ccyValue);
          myEl.$.ccyValue.set("value", "");
          MockInteractions.blur(myEl.$.ccyValue);
          var error = Polymer.dom(myEl.$.ccyValue.root).querySelector('oe-input-error');
          var errorCcy = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.$.ccyValue.invalid, 'invalid is true');
          assert.equal(myEl.$.ccyValue.errorMessage, 'Custom user error message');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'Custom user error message');

          assert.ok(errorCcy, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorCcy).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'Custom user error message');
          assert.isTrue(errorCcy.invalid, 'invalid is true');
          assert.equal(errorCcy.errorMessage, 'Custom user error message');
        });

        test('Check if required throws error', function() {
          myEl.setAttribute("required", true);

          var error = Polymer.dom(myEl.root).querySelector('oe-input-error');
          var errorAmt = Polymer.dom(myEl.$.amtValue.root).querySelector('oe-input-error');
          var errorCcy = Polymer.dom(myEl.$.ccyValue.root).querySelector('oe-input-error');

          MockInteractions.focus(myEl.$.amtValue);
          myEl.$.amtValue.validate();
          MockInteractions.blur(myEl.$.amtValue);
          
          assert.ok(errorAmt, 'oe-input-error exists');
          assert.equal(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.$.amtValue.invalid, 'invalid is true');
          assert.equal(myEl.$.amtValue.errorMessage, 'valueMissing');
          assert.isTrue(errorAmt.invalid, 'invalid is true');
          assert.equal(errorAmt.errorMessage, 'valueMissing');

          assert.ok(error, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'valueMissing');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'valueMissing');

          MockInteractions.focus(myEl.$.amtValue);
          myEl.amount = 123;
          myEl.$.amtValue.validate();
          MockInteractions.blur(myEl.$.amtValue);

          assert.ok(errorAmt, 'oe-input-error exists');
          assert.equal(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isFalse(myEl.$.amtValue.invalid, 'invalid is false');
          assert.isUndefined(myEl.$.amtValue.errorMessage);
          assert.isFalse(errorAmt.invalid, 'invalid is false');
          assert.isUndefined(errorAmt.errorMessage);

          assert.ok(error, 'oe-input-error exists');
          // assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isFalse(myEl.invalid, 'invalid is false');
          assert.equal(myEl.message, '');
          assert.isFalse(error.invalid, 'invalid is false');
          assert.equal(error.errorMessage, '');
        });
      });

      suite('<oe-amount> url', function() {

        var myEl;

        setup(function() {
          myEl = fixture('oe-amount-url');
        });

        test('Check default value of currency list is set', function(done) {
          setTimeout(function() {
            assert.equal(myEl.currency.symbol, '$');
            assert.equal(myEl.currency.name, 'USD');
            assert.equal(myEl.currency.precision, 2);
            done();
          }, 1000);
        });

        test('Set value for amount and check precision', function() {
          myEl.set('amount', 1234.5678);
          assert.equal(myEl.value.amount, 1234.57);
          assert.equal(myEl.value.currency.symbol, '$');
          assert.equal(myEl.value.currency.name, 'USD');
          assert.equal(myEl.value.currency.precision, 2);
        });

        test('Change currency and check precision change', function() {
          myEl.set('currency', myEl.currencyList[1]);
          myEl.set('amount', 1234.5678);
          assert.equal(myEl.value.amount, 1234.568);
          myEl.set('currency', myEl.currencyList[2]);
          assert.equal(myEl.value.amount, 1234.6);
        });

        test('Check float label and underline when focused', function() {
          var eleDecimal = myEl.$.amtValue.querySelector(".underline");
          var eleCombo = myEl.$.ccyValue.querySelector(".underline");
          
          MockInteractions.focus(myEl.$.amtValue);
          assert.isTrue(eleDecimal.classList.contains("is-highlighted"));
          assert.isTrue(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.blur(myEl.$.amtValue);
          assert.isFalse(eleDecimal.classList.contains("is-highlighted"));
          assert.isFalse(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.focus(myEl.$.ccyValue);
          assert.isTrue(eleDecimal.classList.contains("is-highlighted"));
          assert.isTrue(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.focus(myEl.$.amtValue);
          assert.isTrue(eleDecimal.classList.contains("is-highlighted"));
          assert.isTrue(eleCombo.classList.contains("is-highlighted"));
          MockInteractions.blur(myEl.$.amtValue);
          assert.isFalse(eleDecimal.classList.contains("is-highlighted"));
          assert.isFalse(eleCombo.classList.contains("is-highlighted"));
        });

        test('Check _validate method', function() {
          assert.isFalse(myEl._validate());
          myEl.set('amount', 1234.5678);
          assert.isTrue(myEl._validate());
        });

        test('Check numberFormat error for amount', function() {
          var input = myEl.$.amtValue;
          
          MockInteractions.focus(input.inputElement);
          input.inputElement.set('value', 'foobar');
          input.inputElement.fire('change');
          MockInteractions.blur(input.inputElement);
  
  
          forceXIfStamp(input);
          var error = Polymer.dom(input.root).querySelector('oe-input-error');
          var errorAmt = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(input.invalid, 'invalid is true');
          assert.equal(input.errorMessage, 'numberFormat');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'numberFormat');

          assert.ok(errorAmt, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'numberFormat');
          assert.isTrue(errorAmt.invalid, 'invalid is true');
          assert.equal(errorAmt.errorMessage, 'numberFormat');
        });

        test('Check custom error for amount', function() {
          myEl.setAttribute("user-error-message", "Custom user error message")
          var input = myEl.$.amtValue;
          
          MockInteractions.focus(input.inputElement);
          input.inputElement.set('value', 'foobar');
          input.inputElement.fire('change');
          MockInteractions.blur(input.inputElement);
  
  
          forceXIfStamp(input);
          var error = Polymer.dom(input.root).querySelector('oe-input-error');
          var errorAmt = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(input.invalid, 'invalid is true');
          assert.equal(input.errorMessage, 'Custom user error message');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'Custom user error message');

          assert.ok(errorAmt, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'Custom user error message');
          assert.isTrue(errorAmt.invalid, 'invalid is true');
          assert.equal(errorAmt.errorMessage, 'Custom user error message');
        });

        test('Check invalidValue error for currency', function() {
          MockInteractions.focus(myEl.$.ccyValue);
          myEl.$.ccyValue.set("value", "");
          MockInteractions.blur(myEl.$.ccyValue);
          var error = Polymer.dom(myEl.$.ccyValue.root).querySelector('oe-input-error');
          var errorCcy = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.$.ccyValue.invalid, 'invalid is true');
          assert.equal(myEl.$.ccyValue.errorMessage, 'invalidValue');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'invalidValue');

          assert.ok(errorCcy, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorCcy).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'invalidValue');
          assert.isTrue(errorCcy.invalid, 'invalid is true');
          assert.equal(errorCcy.errorMessage, 'invalidValue');
        });

        test('Check custom error for currency', function() {
          myEl.setAttribute("user-error-message", "Custom user error message")
          MockInteractions.focus(myEl.$.ccyValue);
          myEl.$.ccyValue.set("value", "");
          MockInteractions.blur(myEl.$.ccyValue);
          var error = Polymer.dom(myEl.$.ccyValue.root).querySelector('oe-input-error');
          var errorCcy = Polymer.dom(myEl.root).querySelector('oe-input-error');
          assert.ok(error, 'oe-input-error exists');
          assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.$.ccyValue.invalid, 'invalid is true');
          assert.equal(myEl.$.ccyValue.errorMessage, 'Custom user error message');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'Custom user error message');

          assert.ok(errorCcy, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(errorCcy).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'Custom user error message');
          assert.isTrue(errorCcy.invalid, 'invalid is true');
          assert.equal(errorCcy.errorMessage, 'Custom user error message');
        });

        test('Check if required throws error', function() {
          myEl.setAttribute("required", true);

          var error = Polymer.dom(myEl.root).querySelector('oe-input-error');
          var errorAmt = Polymer.dom(myEl.$.amtValue.root).querySelector('oe-input-error');
          var errorCcy = Polymer.dom(myEl.$.ccyValue.root).querySelector('oe-input-error');

          MockInteractions.focus(myEl.$.amtValue);
          myEl.$.amtValue.validate();
          MockInteractions.blur(myEl.$.amtValue);
          
          assert.ok(errorAmt, 'oe-input-error exists');
          assert.equal(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.$.amtValue.invalid, 'invalid is true');
          assert.equal(myEl.$.amtValue.errorMessage, 'valueMissing');
          assert.isTrue(errorAmt.invalid, 'invalid is true');
          assert.equal(errorAmt.errorMessage, 'valueMissing');

          assert.ok(error, 'oe-input-error exists');
          assert.notEqual(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isTrue(myEl.invalid, 'invalid is true');
          assert.equal(myEl.message, 'valueMissing');
          assert.isTrue(error.invalid, 'invalid is true');
          assert.equal(error.errorMessage, 'valueMissing');

          MockInteractions.focus(myEl.$.amtValue);
          myEl.amount = 123;
          myEl.$.amtValue.validate();
          MockInteractions.blur(myEl.$.amtValue);

          assert.ok(errorAmt, 'oe-input-error exists');
          assert.equal(getComputedStyle(errorAmt).display, 'none', 'error is not display:none');
          assert.isFalse(myEl.$.amtValue.invalid, 'invalid is false');
          assert.isUndefined(myEl.$.amtValue.errorMessage);
          assert.isFalse(errorAmt.invalid, 'invalid is false');
          assert.isUndefined(errorAmt.errorMessage);

          assert.ok(error, 'oe-input-error exists');
          // assert.equal(getComputedStyle(error).display, 'none', 'error is not display:none');
          assert.isFalse(myEl.invalid, 'invalid is false');
          assert.equal(myEl.message, '');
          assert.isFalse(error.invalid, 'invalid is false');
          assert.equal(error.errorMessage, '');
        });
      });
    </script>

  </body>
</html>
